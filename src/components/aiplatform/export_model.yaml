name: Export model
description: Export a Vertex AI model from the model registry to GCS.
inputs:
- {name: model_resource_name, type: String, description: The resource name of the
    model to be exported.}
- {name: model_label, type: String, description: Version alias of the model. Defaults
    to None., optional: true}
- name: model_file_name
  type: String
  description: |-
    File name of the model inside the model folder.
    Defaults to None.
  optional: true
outputs:
- name: model
  type: Model
  description: |-
    The exported model as a KFP Model object. This
    parameter will be passed automatically by the orchestrator.
implementation:
  container:
    image: python:3.9
    command:
    - sh
    - -c
    - |2

      if ! [ -x "$(command -v pip)" ]; then
          python3 -m ensurepip || python3 -m ensurepip --user || apt-get install python3-pip
      fi

      PIP_DISABLE_PIP_VERSION_CHECK=1 python3 -m pip install --quiet     --no-warn-script-location 'google-cloud-aiplatform==1.26.0' 'loguru==0.7.0' 'kfp==1.8.22' && "$0" "$@"
    - sh
    - -ec
    - |
      program_path=$(mktemp -d)
      printf "%s" "$0" > "$program_path/ephemeral_component.py"
      python3 -m kfp.v2.components.executor_main                         --component_module_path                         "$program_path/ephemeral_component.py"                         "$@"
    - |2+

      import kfp
      from kfp.v2 import dsl
      from kfp.v2.dsl import *
      from typing import *

      def export_model(
          model_resource_name: str,
          model: Output[Model],
          model_label: str = None,
          model_file_name: str = None,
      ) -> None:
          """Export a Vertex AI model from the model registry to GCS.

          Args:
              model_resource_name (str): The resource name of the model to be exported.
              model (Output[Model]): The exported model as a KFP Model object. This
                  parameter will be passed automatically by the orchestrator.
              model_label (str, optional): Version alias of the model. Defaults to None.
              model_file_name (str, optional): File name of the model inside the model folder.
                  Defaults to None.
          """
          from google.cloud.aiplatform import Model
          from loguru import logger

          model_to_be_exported = Model(model_name=model_resource_name, version=model_label)
          result = model_to_be_exported.export_model(
              export_format_id="custom-trained", artifact_destination=model.uri, sync=True
          )

          model.path = result["artifactOutputUri"]
          if model_file_name:
              model.path += f"/{model_file_name}"
          model.metadata["resourceName"] = model_resource_name
          # model.metadata["model_labels"] = model_to_be_exported.labels["model_label"]
          logger.info(f"Exported model to {model.path}.")

    args:
    - --executor_input
    - {executorInput: null}
    - --function_to_execute
    - export_model
